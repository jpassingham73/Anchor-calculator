<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Elba45 Anchor Scope Calculator</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 10px;
    background: #f8f9fa;
  }
  h1 { font-size: 1.4em; }
  label { display: block; margin-top: 10px; }
  select, input { width: 100%; padding: 5px; margin-top: 5px; }
  button { margin-top: 15px; padding: 10px; width: 100%; background: #007bff; color: white; border: none; }
  #map { height: 200px; margin-top: 10px; }
  #result { background: white; padding: 10px; margin-top: 15px; border-radius: 4px; }
  canvas { margin-top: 15px; background: white; padding: 10px; border-radius: 4px; }
</style>
</head>
<body>

<h1>Elba45 Anchor Scope Calculator</h1>

<label for="depth">Water depth (m):</label>
<input type="number" id="depth" step="0.1" />

<label for="chain">Chain length on board (m):</label>
<input type="number" id="chain" value="100" step="1" />

<label for="model">Weather model:</label>
<select id="model">
  <option value="gfs">GFS (NOAA)</option>
  <option value="ecmwf">ECMWF</option>
  <option value="icon">ICON</option>
</select>

<button id="locate">Use Current Location</button>
<div id="map"></div>

<canvas id="windChart"></canvas>

<button id="calculate">Calculate Scope</button>
<div id="result"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let lat, lon, windData = { gusts: [], times: [] };

// Initialise map
const map = L.map('map').setView([0,0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(map);
let marker;

// Location button
document.getElementById('locate').addEventListener('click', () => {
  navigator.geolocation.getCurrentPosition(pos => {
    lat = pos.coords.latitude;
    lon = pos.coords.longitude;
    map.setView([lat, lon], 14);
    if (marker) marker.remove();
    marker = L.marker([lat, lon]).addTo(map);
    fetchWeather();
  }, err => alert("Location error: " + err.message));
});

// Fetch weather from Open-Meteo
function fetchWeather() {
  const model = document.getElementById('model').value;
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=windspeed_10m,windgusts_10m&forecast_days=1&model=${model}`;
  
  fetch(url).then(res => res.json()).then(data => {
    windData.times = data.hourly.time.map(t => t.split('T')[1]);
    const gusts = data.hourly.windgusts_10m;
    const sustained = data.hourly.windspeed_10m;
    windData.gusts = gusts;
    drawChart(sustained, gusts, windData.times);
  });
}

// Draw wind chart
function drawChart(sustained, gusts, labels) {
  const ctx = document.getElementById('windChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Sustained (kt)', data: sustained.map(k => (k*0.54).toFixed(1)), borderColor: 'blue', fill: false },
        { label: 'Gusts (kt)', data: gusts.map(k => (k*0.54).toFixed(1)), borderColor: 'red', fill: false }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' } }
    }
  });
}

// Scope calculation
document.getElementById('calculate').addEventListener('click', () => {
  const depth = parseFloat(document.getElementById('depth').value);
  const chain = parseFloat(document.getElementById('chain').value);
  if (!depth || !chain || !lat || !lon || windData.gusts.length === 0) {
    alert("Please enter depth, chain, and fetch location/weather first.");
    return;
  }
  
  const bridleLength = 8; // m
  const freeboard = 1.5; // m for Elba45
  const maxGust = Math.max(...windData.gusts) * 0.54; // knots
  let scopeRatio;
  
  if (maxGust < 15) scopeRatio = 4;
  else if (maxGust < 25) scopeRatio = 5;
  else if (maxGust < 35) scopeRatio = 7;
  else scopeRatio = 10;
  
  const required = (depth + freeboard) * scopeRatio - bridleLength;
  
  const msg = `
    <strong>Max forecast gust:</strong> ${maxGust.toFixed(1)} kn<br/>
    <strong>Recommended scope ratio:</strong> ${scopeRatio}:1<br/>
    <strong>Required chain length:</strong> ${required.toFixed(1)} m<br/>
    <strong>Available chain:</strong> ${chain} m<br/>
    ${required <= chain ? '✅ You have enough chain.' : '⚠️ Not enough chain for recommended scope!'}
  `;
  document.getElementById('result').innerHTML = msg;
});
</script>

</body>
</html>
